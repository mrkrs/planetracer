// Generated by CoffeeScript 1.4.0
(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d=this;c=require("node-static");i=new c.Server("./public");a=require("redis");s=require("fs");f=require("request");this.planes={};this.requestsNBR=0;this.start=0;o=require("http").createServer(function(e,t){return e.addListener("end",function(){return i.serve(e,t)})}).listen(8181);u=require("now");r=u.initialize(o);n=a.createClient();r.now.test=function(){d.start=(new Date).getTime();return l()};p=function(n){var i,s,o,u,a,f,l,c,h,p,v;o=n.planes;d.requestsNBR+=1;c={};s=0;for(h=0,v=o.length;h<v;h++){a=o[h];for(p in a){f=a[p];u=""+p+" | "+f[1]+" | "+f[10]+" / "+f[2];if(d.planes[u]==null){s+=1;d.planes[u]=new e(u)}d.planes[u].update(f,function(e,t){return c[e]=t})}}i=0;for(u in c)i+=1;l=0;for(u in d.planes)l+=1;console.log("PLANES : "+l+" | UPDATES : "+i+" | CREATES : "+s);t(c);return r.now.log({updates:i,planes:l,creates:s,requests:d.requestsNBR,start:d.start})};l=function(e){var t;t=(new Date).getTime();console.log("requesting ...");return f("http://planefinder.net/endpoints/update.php?faa=1",function(e,t,n){var r;console.log("received.");r=JSON.parse(n);p(r);return setTimeout(function(){return l()},1e3)})};h=function(e,t){return n.set(e,JSON.stringify(plane),function(){return stream.write(""+id+", "+e+"\n")})};t=function(e){return r.now.getPlane(e)};e=function(){function e(e){this.key=e;this.data={};this.histo=[];this.redisCount=0;return this}e.prototype.update=function(e,t){var n;n=this.test(e);if(n){this.data.type=e[0];this.data.registre=e[1];this.data.flynumber2=e[2];this.data.l_lat=this.data.lat!=null?this.data.lat:null;this.data.l_lon=this.data.lon!=null?this.data.lon:null;this.data.lat=e[3];this.data.lon=e[4];this.data.alt=e[5];this.data.angle=e[6];this.data.speed=e[7];this.data.timestamp=e[8];this.data.unknow=e[9];this.data.flynumber1=e[10];this.data.course=e[11];this.histo.push([this.data.lat,this.data.lon]);this.redisCount+=1;t(this.key,e)}return this};e.prototype.test=function(e){var t,n,r,i,s,o,u,a,f;s=e[3];u=e[4];a=!1;f=this.histo;for(i=0,o=f.length;i<o;i++){r=f[i];r[0]===s&&r[1]===u&&(a=!0)}if(!a){if(this.data.lat!=null&&this.data.lon){t=Math.abs(this.data.lat-s);n=Math.abs(this.data.lon-u);return t<1&&n<1?!0:!1}return!0}return!1};return e}()}).call(this);